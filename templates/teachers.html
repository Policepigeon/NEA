<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #f0f0f0; cursor: pointer; border: 1px solid #ccc; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .student-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .student-card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .file-list { margin-top: 10px; }
        .file-item { padding: 5px; background: #f9f9f9; margin: 2px 0; cursor: pointer; }
        .file-item:hover { background: #e9e9e9; }
        .code-editor { width: 100%; height: 300px; font-family: monospace; }
        .python-runner { margin-top: 20px; }
        textarea { width: 100%; height: 150px; font-size: 16px; }
        pre { background: #f4f4f4; padding: 10px; }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/python/python.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/addon/edit/closebrackets.js"></script>
</head>
<body>
    <div class="container">
        <h1>Teacher Dashboard</h1>
        <p>View and manage student work</p>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('students')">Student Work</div>
            <div class="tab" onclick="showTab('python')">Python Runner</div>
        </div>
        
        <div id="students-tab" class="tab-content active">
            <h2>Student Work Overview</h2>
            <div id="student-list" class="student-list">
                <!-- Student cards will be populated here -->
            </div>
            <h2 style="margin-top:24px;">Create Assignment</h2>
            <div>
                <input id="ass-title" placeholder="Title" style="padding:8px; width: 300px;" />
                <input id="ass-due" type="datetime-local" style="padding:8px;" />
            </div>
            <div style="margin-top:8px;">
                <textarea id="ass-desc" placeholder="Description" style="width: 100%; height: 100px;"></textarea>
            </div>
            <button onclick="createAssignment()">Create</button>
            <h3>Assignments</h3>
            <ul id="ass-list"></ul>
        </div>
        
        <div id="python-tab" class="tab-content python-runner">
            <h2>Python Code Runner</h2>
            <input id="teacher-filename" placeholder="filename.py" style="padding: 8px; width: 240px;" />
            <button onclick="teacherSaveFile()">Save</button>
            <button onclick="teacherNewFile()">New</button>
            <button onclick="teacherDeleteFile()">Delete</button>
            <div style="display:flex; gap: 24px;">
                <div style="flex: 2;">
                    <textarea id="python-code" placeholder="Type your Python code here..."></textarea><br>
                    <button onclick="runPython()">Run Python</button>
                </div>
                <div style="flex: 1;">
                    <h3>Your files</h3>
                    <ul id="teacher-file-list"></ul>
                </div>
            </div>
            <h3>Output:</h3>
            <pre id="output"></pre>
        </div>
    </div>

    <script>
        let pyodideReadyPromise = loadPyodide();
        let currentStudentWork = null;
        let editor = null;
        let teacherFilesLoaded = false;

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        async function loadStudentWork() {
            try {
                const response = await fetch('/api/teacher/students');
                if (!response.ok) throw new Error('Failed to load student work');
                currentStudentWork = await response.json();
                displayStudentWork();
            } catch (error) {
                console.error('Error loading student work:', error);
                document.getElementById('student-list').innerHTML = '<p>Error loading student work</p>';
            }
        }

        function displayStudentWork() {
            const container = document.getElementById('student-list');
            container.innerHTML = '';
            
            if (currentStudentWork.length === 0) {
                container.innerHTML = '<p>No students found</p>';
                return;
            }
            
            currentStudentWork.forEach(studentData => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <h3>${studentData.student.name}</h3>
                    <p>Email: ${studentData.student.email}</p>
                    <p>Files: ${studentData.files.length}</p>
                    <div class="file-list">
                        ${studentData.files.map(file => 
                            `<div class="file-item" onclick="viewStudentFile('${studentData.student.email}', '${file.filename}')">
                                ${file.filename} (${new Date(file.updated_at).toLocaleDateString()})
                            </div>`
                        ).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function viewStudentFile(studentEmail, filename) {
            try {
                const response = await fetch(`/api/teacher/students/${encodeURIComponent(studentEmail)}/files/${encodeURIComponent(filename)}`);
                if (!response.ok) throw new Error('Failed to load file');
                const fileData = await response.json();
                
                // Show file content in a modal or new section
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                    align-items: center; justify-content: center;
                `;
                modal.innerHTML = `
                    <div style="background: white; padding: 20px; max-width: 80%; max-height: 80%; overflow: auto;">
                        <h3>${filename} - ${fileData.student?.name || 'Unknown Student'}</h3>
                        <pre style="background: #f4f4f4; padding: 10px; white-space: pre-wrap;">${fileData.content}</pre>
                        <button onclick="this.parentElement.parentElement.remove()">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading file:', error);
                alert('Failed to load file');
            }
        }

        async function createAssignment() {
            const title = document.getElementById('ass-title').value.trim();
            const description = document.getElementById('ass-desc').value.trim();
            const dueDate = document.getElementById('ass-due').value; // local datetime
            if (!title) return alert('Enter a title');
            const res = await fetch('/api/assignments', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, description, dueDate })
            });
            if (!res.ok) return alert('Failed to create');
            await refreshAssignments();
        }

        async function refreshAssignments() {
            const ul = document.getElementById('ass-list');
            ul.innerHTML = '';
            const res = await fetch('/api/assignments');
            if (!res.ok) return;
            const items = await res.json();
            for (const a of items) {
                const li = document.createElement('li');
                const due = a.dueDate ? `${a.dueDate.year}-${String(a.dueDate.month).padStart(2,'0')}-${String(a.dueDate.day).padStart(2,'0')}` : 'No due date';
                li.textContent = `${a.title} - ${due}`;
                ul.appendChild(li);
            }
        }

        async function runPython() {
            const code = editor ? editor.getValue() : document.getElementById('python-code').value;
            const outputElem = document.getElementById('output');
            outputElem.textContent = "Running...";
            try {
                const pyodide = await pyodideReadyPromise;
                await pyodide.runPythonAsync(`
import sys
from io import StringIO
sys.stdout = sys.stderr = StringIO()
`);
                await pyodide.runPythonAsync(code);
                const output = await pyodide.runPythonAsync("sys.stdout.getvalue()");
                outputElem.textContent = output || "No output.";
            } catch (err) {
                outputElem.textContent = err;
            }
        }

        function initEditor() {
            const textarea = document.getElementById('python-code');
            editor = CodeMirror.fromTextArea(textarea, {
                mode: 'python',
                lineNumbers: true,
                autoCloseBrackets: true,
                theme: 'default'
            });
            editor.setSize('100%', 300);
        }

        async function teacherRefreshList() {
            const ul = document.getElementById('teacher-file-list');
            ul.innerHTML = '';
            try {
                const res = await fetch('/api/files');
                if (!res.ok) throw new Error('Failed to list files');
                const rows = await res.json();
                for (const r of rows) {
                    const li = document.createElement('li');
                    const a = document.createElement('a');
                    a.href = '#';
                    a.textContent = r.filename;
                    a.onclick = async (e) => {
                        e.preventDefault();
                        await teacherOpenFile(r.filename);
                    };
                    li.appendChild(a);
                    ul.appendChild(li);
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function teacherOpenFile(name) {
            try {
                const res = await fetch(`/api/files/${encodeURIComponent(name)}`);
                if (!res.ok) throw new Error('Not found');
                const data = await res.json();
                document.getElementById('teacher-filename').value = data.filename;
                if (editor) { editor.setValue(data.content); } else { document.getElementById('python-code').value = data.content; }
            } catch (e) {
                alert('Could not open file');
            }
        }

        async function teacherSaveFile() {
            const filename = document.getElementById('teacher-filename').value.trim();
            const content = editor ? editor.getValue() : document.getElementById('python-code').value;
            if (!filename) return alert('Enter a filename');
            const res = await fetch('/api/files', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename, content })
            });
            if (!res.ok) return alert('Save failed');
            await teacherRefreshList();
        }
        async function teacherDeleteFile() {
            const filename = document.getElementById('teacher-filename').value.trim();
            if (!filename) return alert('Enter a filename');
            if (!confirm(`Delete ${filename}?`)) return;
            const res = await fetch(`/api/files/${encodeURIComponent(filename)}`, { method: 'DELETE' });
            if (!res.ok) return alert('Delete failed');
            if (editor) { editor.setValue(''); } else { document.getElementById('python-code').value = ''; }
            await teacherRefreshList();
        }
        function teacherNewFile() {
            document.getElementById('teacher-filename').value = '';
            if (editor) { editor.setValue(''); } else { document.getElementById('python-code').value = ''; }
        }

        // Load student work on page load
        loadStudentWork();
        initEditor();
        teacherRefreshList();
        refreshAssignments();
    </script>
</body>
</html>
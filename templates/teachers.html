<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Teacher Dashboard</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #f0f0f0; cursor: pointer; border: 1px solid #ccc; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .student-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .student-card { border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .file-list { margin-top: 10px; }
        .file-item { padding: 5px; background: #f9f9f9; margin: 2px 0; cursor: pointer; }
        .file-item:hover { background: #e9e9e9; }
        .code-editor { width: 100%; height: 300px; font-family: monospace; }
        .python-runner { margin-top: 20px; }
        textarea { width: 100%; height: 150px; font-size: 16px; }
        pre { background: #f4f4f4; padding: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Teacher Dashboard</h1>
        <p>View and manage student work</p>
        
        <div class="tabs">
            <div class="tab active" onclick="showTab('students')">Student Work</div>
            <div class="tab" onclick="showTab('python')">Python Runner</div>
        </div>
        
        <div id="students-tab" class="tab-content active">
            <h2>Student Work Overview</h2>
            <div id="student-list" class="student-list">
                <!-- Student cards will be populated here -->
            </div>
        </div>
        
        <div id="python-tab" class="tab-content python-runner">
            <h2>Python Code Runner</h2>
            <textarea id="python-code" placeholder="Type your Python code here..."></textarea><br>
            <button onclick="runPython()">Run Python</button>
            <h3>Output:</h3>
            <pre id="output"></pre>
        </div>
    </div>

    <script>
        let pyodideReadyPromise = loadPyodide();
        let currentStudentWork = null;

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        async function loadStudentWork() {
            try {
                const response = await fetch('/api/teacher/students');
                if (!response.ok) throw new Error('Failed to load student work');
                currentStudentWork = await response.json();
                displayStudentWork();
            } catch (error) {
                console.error('Error loading student work:', error);
                document.getElementById('student-list').innerHTML = '<p>Error loading student work</p>';
            }
        }

        function displayStudentWork() {
            const container = document.getElementById('student-list');
            container.innerHTML = '';
            
            if (currentStudentWork.length === 0) {
                container.innerHTML = '<p>No students found</p>';
                return;
            }
            
            currentStudentWork.forEach(studentData => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <h3>${studentData.student.name}</h3>
                    <p>Email: ${studentData.student.email}</p>
                    <p>Files: ${studentData.files.length}</p>
                    <div class="file-list">
                        ${studentData.files.map(file => 
                            `<div class="file-item" onclick="viewStudentFile('${studentData.student.email}', '${file.filename}')">
                                ${file.filename} (${new Date(file.updated_at).toLocaleDateString()})
                            </div>`
                        ).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function viewStudentFile(studentEmail, filename) {
            try {
                const response = await fetch(`/api/teacher/students/${encodeURIComponent(studentEmail)}/files/${encodeURIComponent(filename)}`);
                if (!response.ok) throw new Error('Failed to load file');
                const fileData = await response.json();
                
                // Show file content in a modal or new section
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                    align-items: center; justify-content: center;
                `;
                modal.innerHTML = `
                    <div style="background: white; padding: 20px; max-width: 80%; max-height: 80%; overflow: auto;">
                        <h3>${filename} - ${fileData.student?.name || 'Unknown Student'}</h3>
                        <pre style="background: #f4f4f4; padding: 10px; white-space: pre-wrap;">${fileData.content}</pre>
                        <button onclick="this.parentElement.parentElement.remove()">Close</button>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading file:', error);
                alert('Failed to load file');
            }
        }

        async function runPython() {
            const code = document.getElementById('python-code').value;
            const outputElem = document.getElementById('output');
            outputElem.textContent = "Running...";
            try {
                const pyodide = await pyodideReadyPromise;
                await pyodide.runPythonAsync(`
import sys
from io import StringIO
sys.stdout = sys.stderr = StringIO()
`);
                await pyodide.runPythonAsync(code);
                const output = await pyodide.runPythonAsync("sys.stdout.getvalue()");
                outputElem.textContent = output || "No output.";
            } catch (err) {
                outputElem.textContent = err;
            }
        }

        // Load student work on page load
        loadStudentWork();
    </script>
</body>
</html>